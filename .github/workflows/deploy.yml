name: Deploy to AWS

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  SAM_STACK_NAME: pulse-engagement-tracker
  S3_BUCKET: engagement-tracker-frontend-dev-913524910742
  CLOUDFRONT_DISTRIBUTION_ID: EIH5YHS6N2FOK

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up SAM CLI
        uses: aws-actions/setup-sam@v2

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Build SAM application
        run: sam build

      - name: Deploy SAM stack
        run: |
          sam deploy \
            --stack-name pulse-engagement-tracker \
            --no-confirm-changeset \
            --no-fail-on-empty-changeset \
            --capabilities CAPABILITY_IAM \
            --parameter-overrides Environment=dev

      - name: Get stack outputs
        id: get-outputs
        run: |
          API_URL=$(aws cloudformation describe-stacks \
            --stack-name pulse-engagement-tracker \
            --query "Stacks[0].Outputs[?OutputKey=='ApiUrl'].OutputValue" \
            --output text)
          echo "api_url=${API_URL}" >> $GITHUB_OUTPUT

      - name: Update frontend config
        env:
          API_URL_VALUE: ${{ steps.get-outputs.outputs.api_url }}
        run: |
          cat > frontend/config.js << CONFIGEOF
          // Configuration - Auto-generated by GitHub Actions
          // Deployed: $(date -u +"%Y-%m-%dT%H:%M:%SZ")

          const API_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
              ? 'http://localhost:3000'
              : '${API_URL_VALUE}';
          CONFIGEOF

      - name: Deploy frontend to S3
        run: |
          aws s3 sync frontend/ s3://engagement-tracker-frontend-dev-913524910742/ \
            --delete \
            --cache-control "max-age=31536000" \
            --exclude "*.html"

          aws s3 sync frontend/ s3://engagement-tracker-frontend-dev-913524910742/ \
            --cache-control "max-age=0, no-cache, no-store, must-revalidate" \
            --exclude "*" \
            --include "*.html"

      - name: Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id EIH5YHS6N2FOK \
            --paths "/*"

      - name: Post deployment summary
        run: |
          echo "## Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Site:** https://pulse.elelem.expert" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**API:** ${{ steps.get-outputs.outputs.api_url }}" >> $GITHUB_STEP_SUMMARY
